<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setic Vision S7 - Streaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-6 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
            <h1 class="text-2xl font-bold text-blue-400">Setic Vision Supervision</h1>
            <div id="status" class="px-4 py-2 bg-green-600 rounded font-bold text-sm">PLC: OK</div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="flex flex-col gap-6">
                <div id="alarmIndicator" class="bg-slate-800 border-4 border-slate-600 rounded-xl p-6 flex items-center justify-center min-h-[120px]">
                    <h2 id="txtSystemStatus" class="text-2xl font-bold text-gray-400">SYSTÈME OK</h2>
                </div>

                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-4">
                    <button id="btnStart" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-lg font-bold text-lg">▶ CONNECTER CAMÉRA</button>
                    <button id="btnReset" class="w-full bg-orange-600 py-4 rounded-lg font-bold opacity-50 cursor-not-allowed" disabled>↺ RESET DÉFAUT</button>
                    
                    <div class="pt-4 border-t border-slate-700">
                        <label class="block text-gray-400 mb-2">Couleur Cible</label>
                        <input type="color" id="colorPicker" value="#0050ff" class="w-full h-10 rounded cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between"><label class="text-gray-400">Tolérance</label><span id="lblTol" class="text-blue-400">30</span></div>
                        <input type="range" id="rngTol" min="5" max="100" value="30" class="w-full h-2 bg-slate-600 rounded-lg">
                    </div>
                    <div>
                        <div class="flex justify-between"><label class="text-gray-400">Surface Min (px)</label><span id="lblArea" class="text-blue-400">500</span></div>
                        <input type="range" id="rngArea" min="100" max="5000" value="500" class="w-full h-2 bg-slate-600 rounded-lg">
                    </div>
                </div>
            </div>

            <div class="relative bg-black rounded-xl border-2 border-slate-700 flex justify-center items-center overflow-hidden shadow-2xl min-h-[400px]">
                <img id="videoStream" src="" class="absolute inset-0 w-full h-full object-contain" crossorigin="anonymous">
                <canvas id="outputCanvas" class="relative z-10 w-full h-full object-contain"></canvas>
                
                <div id="waitingOverlay" class="absolute inset-0 flex items-center justify-center text-gray-500 pointer-events-none">
                    <span class="text-lg">En attente de connexion...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VARS
        const imgStream = document.getElementById('videoStream');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let isRunning = false, alarmLocked = false;
        let targetHSV = { h: 220, s: 100, v: 100 };
        const WIDTH = 640; const HEIGHT = 480;
        canvas.width = WIDTH; canvas.height = HEIGHT;

        // UI LISTENERS
        document.getElementById('rngTol').oninput = (e) => document.getElementById('lblTol').innerText = e.target.value;
        document.getElementById('rngArea').oninput = (e) => document.getElementById('lblArea').innerText = e.target.value;
        document.getElementById('colorPicker').oninput = function() { const rgb=hexToRgb(this.value); targetHSV=rgbToHsv(rgb.r, rgb.g, rgb.b); };
        (() => { const rgb=hexToRgb(document.getElementById('colorPicker').value); targetHSV=rgbToHsv(rgb.r, rgb.g, rgb.b); })();

        // --- DÉMARRAGE DU STREAM ---
        document.getElementById('btnStart').onclick = () => {
            // On connecte l'image au flux du Raspberry Pi
            imgStream.src = "/api/video_stream";
            
            imgStream.onload = () => {
                if(!isRunning) {
                    isRunning = true;
                    document.getElementById('btnStart').disabled = true;
                    document.getElementById('btnStart').className = "w-full bg-green-600 text-white py-4 rounded-lg font-bold cursor-default";
                    document.getElementById('btnStart').innerText = "● LIVE STREAM ACTIF";
                    document.getElementById('waitingOverlay').classList.add('hidden');
                    processLoop(); // Lance l'analyse
                }
            };
        };

        // --- BOUCLE D'ANALYSE ---
        function processLoop() {
            if(!isRunning) return;

            // 1. Dessiner l'image reçue sur le canvas pour lire les pixels
            ctx.drawImage(imgStream, 0, 0, WIDTH, HEIGHT);
            
            const frame = ctx.getImageData(0, 0, WIDTH, HEIGHT);
            const d = frame.data;
            const tol = parseInt(document.getElementById('rngTol').value);
            const thr = parseInt(document.getElementById('rngArea').value);
            
            let cnt=0; let minX=WIDTH, maxX=0, minY=HEIGHT, maxY=0;
            let sumR=0, sumG=0, sumB=0;

            for(let i=0; i<d.length; i+=4) {
                const r=d[i], g=d[i+1], b=d[i+2];
                if(r<30 && g<30 && b<30) continue; // Ignorer le noir/sombre

                const hsv = rgbToHsv(r, g, b);
                let diff = Math.abs(hsv.h - targetHSV.h);
                if(diff > 180) diff = 360 - diff;
                
                if(diff < tol && hsv.s > 40 && hsv.v > 30) {
                    cnt++;
                    sumR += r; sumG += g; sumB += b;
                    const x=(i/4)%WIDTH; const y=Math.floor((i/4)/WIDTH);
                    if(x<minX) minX=x; if(x>maxX) maxX=x; if(y<minY) minY=y; if(y>maxY) maxY=y;
                }
            }

            // 2. Nettoyer et Redessiner l'image propre
            ctx.drawImage(imgStream, 0, 0, WIDTH, HEIGHT);

            // 3. Gestion Alarme
            if(cnt > thr && !alarmLocked) {
                alarmLocked = true;
                sendPLC(true); // Envoie l'ordre au Raspberry Pi
                triggerAlarmUI();
            }

            // 4. Affichage Rectangle & RGB
            if(alarmLocked || cnt > thr) {
                if(cnt > thr) {
                    const w = maxX - minX; const h = maxY - minY;
                    ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 4;
                    ctx.strokeRect(minX, minY, w, h);
                    
                    const avgR = Math.round(sumR/cnt); const avgG = Math.round(sumG/cnt); const avgB = Math.round(sumB/cnt);
                    ctx.fillStyle = "#00FF00"; ctx.font = "bold 16px Arial";
                    ctx.fillText(`DÉFAUT: ${cnt}px`, minX, minY - 25);
                    ctx.fillStyle = "#FFFFFF"; ctx.font = "14px monospace";
                    ctx.fillText(`RGB: ${avgR},${avgG},${avgB}`, minX, minY - 8);
                }
            }
            requestAnimationFrame(processLoop);
        }

        // --- COMMUNICATIONS ---
        async function sendPLC(alarm) {
            try { await fetch('/api/alarm',{method:'POST',body:JSON.stringify({alarm:alarm})}); } catch(e){console.error(e);}
        }

        function triggerAlarmUI() {
            const ind = document.getElementById('alarmIndicator');
            ind.className = "bg-red-600 border-4 border-white rounded-xl p-6 flex items-center justify-center animate-pulse min-h-[120px]";
            document.getElementById('txtSystemStatus').innerText = "⚠️ DÉFAUT DÉTECTÉ";
            document.getElementById('txtSystemStatus').className = "text-2xl font-bold text-white";
            const btn = document.getElementById('btnReset');
            btn.disabled = false; btn.className = "w-full bg-orange-600 hover:bg-orange-500 py-4 rounded-lg font-bold animate-pulse";
        }

        document.getElementById('btnReset').onclick = () => {
            sendPLC(false); alarmLocked = false;
            document.getElementById('alarmIndicator').className = "bg-slate-800 border-4 border-slate-600 rounded-xl p-6 flex items-center justify-center min-h-[120px]";
            document.getElementById('txtSystemStatus').innerText = "SYSTÈME OK";
            document.getElementById('txtSystemStatus').className = "text-2xl font-bold text-gray-400";
            document.getElementById('btnReset').disabled = true;
            document.getElementById('btnReset').className = "w-full bg-orange-600 py-4 rounded-lg font-bold opacity-50 cursor-not-allowed";
        };

        // --- UTILS ---
        function hexToRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
        function rgbToHsv(r,g,b){r/=255,g/=255,b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min;let h,s=max===0?0:d/max,v=max;if(max!==min){switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h:h*360,s:s*100,v:v*100}}
    </script>
</body>
</html>